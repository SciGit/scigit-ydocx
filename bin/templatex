#!/usr/bin/env ruby
# coding: utf-8

require 'json'
require 'optparse'
require 'yaml'
#require 'ruby-prof'

if $0 == __FILE__
  require 'pathname'
  root = Pathname.new(__FILE__).realpath.parent.parent
  $:.unshift root.join('lib')
end

require 'ydocx/document'

options = {}
optparse = OptionParser.new do |opts|
  opts.on('-x', '--extract SECTION', 'Extract the section into the output document') do |section|
    options[:extract_section] = section
  end

  opts.on('-r', '--replace SECTIONS', 'Replace the specified sections with the related documents. ' +
                                      'Expected format is section1=file1,section2=file2,...') do |sections|
    sections = sections.split(',')
    options[:replace_sections] = {}
    sections.each do |replace|
      section, file = replace.split('=')
      options[:replace_sections][section] = YDocx::Document.extract_document(file)
    end
  end
end

optparse.parse!

data = JSON.parse('{"id":"13fef1c5b2700298fd91", "date": 1375302679, "account_number":{"updated_at":1374106233232,"value":"Account Num"},"address":{"updated_at":1374106233232,"value":"Addresss"},"american_percent":{"updated_at":1374106425489,"value":"48"},"annual_gross_receipts":{"updated_at":1374628910819,"value":"1123"},"annual_payroll":{"updated_at":1374106425489,"value":"30"},"business_start_date":{"updated_at":1374106425489,"value":"2003-03-03"},"business_type":{"updated_at":1374106233232,"value":"Individual"},"canadian_percent":{"updated_at":1374106425489,"value":"49"},"city":{"updated_at":1374106233232,"value":"Cityy"},"claims_infos":{"updated_at":1374106390158,"value":[{"loss_date":{"value":"2203-11-02"},"claim_type":{"value":"Claime"},"description":{"value":"Desc"},"amount_paid":{"value":"30"},"reserve":{"value":"5"}},{"loss_date":{"value":"0003-03-03"},"claim_type":{"value":"o"},"description":{"value":"y"},"amount_paid":{"value":"0009"},"reserve":{"value":"233"}}]},"client_contacts":{"updated_at":1374106285194,"value":[{"name":{"value":"Namee"},"title":{"value":"Titlee"},"position":{"value":"Bitch"},"phone":{"value":"1112223333"},"email":{"value":"email@contact.com"},"other":{"value":"Oh"}},{"name":{"value":"Sudo su"},"title":{"value":"suuuuuuu"},"position":{"value":"Accountant"},"phone":{"value":"1112223333"},"email":{"value":"aws@sherk.me"},"other":{"value":"akljdhsf"}}]},"company":{"updated_at":1374691926373,"value":"Companyy"},"country":{"updated_at":1374106233232,"value":"Countryy"},"coverage_from":{"updated_at":1374106445802,"value":"2009-03-05"},"coverage_to":{"updated_at":1374106445802,"value":"2010-03-05"},"covered":{"updated_at":1374106425489,"value":"fail coverage"},"created_at":"2013-07-18T00:10:33Z","date_known":{"updated_at":1374106460197,"value":"0001-01-01"},"description_operations":{"updated_at":1374106285194,"value":"Being bitches"},"email_address":{"updated_at":1374106233232,"value":"a@b.com"},"exposure_or_receipts":{"updated_at":1374620504624,"value":[]},"fax":{"updated_at":1374690111853,"value":"5194048125"},"foreign_percent":{"updated_at":1374106425489,"value":"3"},"full_time_employees":{"updated_at":1374106425489,"value":"5"},"industry_code":{"updated_at":1374106285194,"value":"111111"},"locations":{"updated_at":1374709277757,"value":[{"location_number":{"value":"#1"},"location_type":{"value":"Urban"},"location_address":{"value":"123 Fake St."},"location_city":{"value":"Faketown"},"location_postal_code":{"value":"123456"},"risk_info_type":{"value":"Commercial Equipment"},"inspection":{"value":""},"inspection_date":{"value":"2333-03-03"},"inspected_by":{"value":"penisclown"},"risk_severity":{"value":"very_good"},"scope_of_insured_property":{"value":"ALL THE THINGS"},"risk_info_notes":{"value":"aasdf"},"risk_info_limit":{"value":"asdf"},"construction_stories":{"value":"ffdfdf"},"year_built":{"value":"assdf"},"construction_area":{"value":{"qty": "1234", "unit": "Sq. ft"}},"construction_walls":{"value":"Steel on steel"},"construction_floors":{"value":"Frame and all other"},"construction_basement":{"value":"Non-combustible without masonry"},"construction_roof":{"value":"Steel Beam"},"construction_roof_covering":{"value":"Metal"},"construction_electrical":{"value":"Fuses"},"construction_plumbing":{"value":"Galvanized"},"construction_heating":{"value":"Slow wood burning/air tight stove"},"construction_fuel":{"value":"Naptha gas"},"renovations_none_known":{"value":{"yes":true}},"renovations_electrical":{"value":{"yes":true}},"renovations_plumbing":{"value":{"yes":true}},"renovations_heating":{"value":{"yes":true}},"renovations_roof":{"value":{"yes":true}},"renovations_roof_year":{"value":"2010"},"renovations_roof_complete_partial":{"value":"complete"},"fire_hydrants":{"value":"Within 300m"},"fire_department":{"value":"Within 5km"},"extinguishing_system":{"value":"Sprinkler"},"extinguishing_agent":{"value":"chemical"},"fire_alarm":{"value":"Central Station"},"coverage_percent":{"value":"50"},"standpipe":{"value":{"yes":true}},"other_fire_info":{"value":"oh"},"protection_types":{"value":{"concealed":true,"sturdy_doors":true,"motion_lighting":true,"perimeter":true,"steel_post":true,"other":false}},"burglar_alarm":{"value":"Central Station"},"safe_type":{"value":"burglary"},"safe_class":{"value":"6"},"crime_protection_other":{"value":"asdfkllk"},"occupancy_insured":{"value":"ljkhasdfkljh"},"occupancy_others":{"value":"ljhaksdlhfkljasdf"},"exposures_clear":{"value":{"yes":false}},"exposures_left":{"value":"left"},"exposures_right":{"value":"right"},"exposures_behind":{"value":"behind"},"buildings":{"value":[{"building_number":{"value":"1"},"address":{"value":"asd"},"description":{"value":"asdf"},"coinsurance":{"value":"asdf"},"replacement_cost":{"value":""}}]},"coverage_schedules":{"value":[{"type":{"value":"Gross Earnings–Mercantile or Non-Manufacturing "},"category":{"value":"Business Interruption"},"coinsurance":{"value":"1"}},{"type":{"value":"Building"},"category":{"value":"Property"},"subtype":{"value":"named"},"replacement_cost":{"value":"12345"},"coinsurance":{"value":"90%"},"limit":{"value":"12345"}}]},"auto_schedules":{"value":[{"item_number":{"value":"123"},"unit_number":{"value":"1322"},"owner":{"value":"Contractor"},"finance_company":{"value":"yes"},"year":{"value":"9"},"make":{"value":"lkajsf"},"model":{"value":"lkjalskdf"},"serial_number":{"value":"lkjaklsf"},"plate_number":{"value":"kjhklasdf"},"colour":{"value":"jklhkjl"},"lessor":{"value":"h"},"date_added":{"value":"0001-01-01"},"policy_expiry":{"value":"0020-02-23"},"deleted":{"value":"0123-12-31"},"premium":{"value":"5"},"premium_credit":{"value":"6"},"cargo":{"value":"7"},"cargo_credit":{"value":"8"}},{"item_number":{"value":"124"},"unit_number":{"value":"9123"},"owner":{"value":"penisclowns"},"finance_company":{"value":"yes"},"year":{"value":"3"},"make":{"value":"yes"},"model":{"value":"ih"},"serial_number":{"value":"kjo"},"plate_number":{"value":"3"},"colour":{"value":"o"},"lessor":{"value":"ihio"},"date_added":{"value":"0001-01-02"},"policy_expiry":{"value":"0023-02-03"},"deleted":{"value":"0203-02-03"},"premium":{"value":"5"},"premium_credit":{"value":"4"},"cargo":{"value":"3"},"cargo_credit":{"value":"2"}}]},"equipment_schedules":{"value":[{"type":{"value":"Motor Truck Cargo"},"item_number":{"value":"111"},"year":{"value":3},"make":{"value":"ford"},"model":{"value":"penis-XL"},"serial_number":{"value":"oh"},"description":{"value":"do things"},"limit":{"value":"5"}},{"type":{"value":"junkinthetrunk"},"item_number":{"value":"50"},"year":{"value":30},"make":{"value":"make"},"model":{"value":"mode"},"serial_number":{"value":"seri"},"description":{"value":"dec"},"limit":{"value":"501"}}]},"miscellaneous_schedules":{"value":[{"type":{"value":"miscsched"},"item_number":{"value":"033"},"year":{"value":13},"make":{"value":"klaj"},"model":{"value":"lkjkl"},"serial_number":{"value":"hklj"},"description":{"value":"hlh"},"limit":{"value":"jkh"}},{"type":{"value":"Motor Truck Cargo"},"item_number":{"value":"303030"},"year":{"value":193},"make":{"value":"jklh"},"model":{"value":"jk"},"serial_number":{"value":"hklj"},"description":{"value":"hklj"},"limit":{"value":"hkl"}}]},"drivers":{"value":[{"driver":{"value":"1"},"name":{"value":"Hanson Wang"},"license_number":{"value":"asdfasdfasdfasdf"},"date_employed":{"value":"2013-01-01"},"accidents":{"value":"0"},"convictions":{"value":"0"}}]},"loss_control_surveys":{"value":[{"survey_performed_by":{"value":"Hanson Wang"},"survey_interviewee":{"value":"asdf"},"survey_heating_serviced":{"value":{"yes":true}},"survey_comb_clearance":{"value":{"yes":true}},"survey_temporary_heating":{"value":{"yes":true}}}]},"photos":{"value":[{"photo_notes":{"value":"notes"}}]}},{"location_number":{"value":"#2"},"location_type":{"value":"Rural"},"location_address":{"value":"asdf"},"location_city":{"value":"asdf"},"country":{"value":""},"location_postal_code":{"value":"asdf"},"risk_info_type":{"value":"Commercial Equipment"},"inspection":{},"scope_of_insured_property":{"value":"asdf"},"risk_info_notes":{"value":"asdf"},"risk_info_limit":{"value":"asdf"},"construction_stories":{"value":"asdf"},"year_built":{"value":"asdf"},"construction_area":{"value":{"qty": "asdf", "unit": "Sq. m"}},"construction_walls":{"value":"Frame w/ brick veneer"},"construction_floors":{"value":"Concrete panels on steel structure"},"construction_basement":{"value":"Non-combustible with masonry"},"construction_roof":{"value":"Poured concrete"},"construction_roof_covering":{"value":"Concrete on steel structure"},"construction_electrical":{"value":"Fuses"},"construction_plumbing":{"value":"Stainless Steel"},"construction_heating":{"value":"Electric"},"construction_fuel":{"value":"Electric"},"renovations_none_known":{"value":{"yes":true}},"renovations_electrical":{"value":{"yes":false}},"renovations_plumbing":{"value":{"yes":false}},"renovations_heating":{"value":{"yes":false}},"renovations_heating_year":{"value":"1"},"renovations_heating_complete_partial":{"value":"complete"},"renovations_roof":{"value":{"yes":false}},"renovations_roof_year":{"value":"1"},"fire_hydrants":{"value":"Within 300m"},"fire_department":{"value":"Within 8km"},"extinguishing_system":{"value":"None"},"extinguishing_agent":{"value":"automatic_cO2"},"fire_alarm":{"value":"Monitoring Station (Full)"},"coverage_percent":{"value":"1"},"standpipe":{"value":{"yes":true}},"other_fire_info":{"value":"asdf"},"protection_types":{"value":{"deadbolt":true,"watchmen":true,"additional_key":true,"common_walls":true,"holdup_buttons":true,"perimeter":true,"steel_post":true,"other":false}},"burglar_alarm":{"value":"Partial"},"safe_type":{"value":"burglary"},"safe_class":{"value":"3"},"crime_protection_other":{"value":"asdf"},"occupancy_insured":{"value":"asdf"},"occupancy_others":{"value":"asdf"},"exposures_clear":{"value":{"yes":true}},"coverage_schedules":{"value":[{"type":{"value":"Earnings – No Co-Insurance"},"category":{"value":"Business Interruption"},"deductible":{"value":"1"},"limit":{"value":"1"}},{"type":{"value":"Owners’, Landlords’, and Tenants’ Liability"},"category":{"value":"Liability"},"deductible":{"value":"1"},"limit":{"value":"1"}},{"type":{"value":"Business Interruption (Actual Loss)"},"category":{"value":"Machinery Breakdown"},"deductible":{"value":"1"},"limit":{"value":"1"}}]},"auto_schedules":{"value":[{"item_number":{"value":"1"},"unit_number":{"value":"1"},"owner":{"value":"Owner-operator"},"finance_company":{"value":"asdf"},"year":{"value":"asdf"},"make":{"value":"asdf"},"model":{"value":"adfs"},"serial_number":{"value":"adsf"},"plate_number":{"value":"adfs"},"colour":{"value":"afds"},"lessor":{"value":"adfsdfs"},"date_added":{"value":"2222-02-02"},"policy_expiry":{"value":"0002-02-02"},"deleted":{"value":"0002-02-03"},"premium":{"value":"123"},"premium_credit":{"value":"123"},"cargo":{"value":"123"},"cargo_credit":{"value":"123"}},{"item_number":{"value":"2"},"unit_number":{"value":"2"},"owner":{"value":"Contractor"},"finance_company":{"value":"asf"},"year":{"value":"hjgk"},"make":{"value":"jg"},"model":{"value":"gjhk"},"serial_number":{"value":"ghjk"},"plate_number":{"value":"ghj"},"colour":{"value":"ghk"},"lessor":{"value":"hgj"},"date_added":{"value":"0001-01-01"},"policy_expiry":{"value":"0001-01-01"},"deleted":{"value":"0001-01-01"},"premium":{"value":"123"},"premium_credit":{"value":"123"},"cargo":{"value":"123"},"cargo_credit":{"value":"123"}}]},"equipment_schedules":{"value":[{"type":{"value":"Miscellaneous Property"},"item_number":{"value":"123"},"year":{"value":123},"make":{"value":"asdf"},"model":{"value":"asdf"},"serial_number":{"value":"adsf"},"description":{"value":"asdf"},"limit":{"value":"asdf"}},{"type":{"value":"asdf"},"item_number":{"value":"123"},"year":{"value":123},"make":{"value":"asdf"},"model":{"value":"asdf"},"serial_number":{"value":"asdf"},"description":{"value":"asdf"},"limit":{"value":"asdf"}}]},"miscellaneous_schedules":{"value":[{"type":{"value":"Fine Arts"},"item_number":{"value":"123"},"year":{"value":123},"make":{"value":"123"},"model":{"value":"123"},"serial_number":{"value":"123"},"description":{"value":"123"},"limit":{"value":"123"}},{"type":{"value":"asdf"},"item_number":{"value":"3333"},"year":{"value":123},"make":{"value":"asdf"},"model":{"value":"asdf"},"serial_number":{"value":"asdf"},"description":{"value":"asdf"},"limit":{"value":"asdf"}}]},"photos":{"value":[]}}]},"name":{"updated_at":1374691926374,"value":"asdf"},"new_client":{"updated_at":1374624146906,"value":{"yes":true}},"notes":{"updated_at":1374106451788,"value":"how do i shot web"},"part_time_employees":{"updated_at":1374106425489,"value":"5"},"phone":{"updated_at":1374686742623,"value":"5194048125 x 123"},"policy_infos":{"updated_at":1374691420637,"value":[{"prev_insurer":{"value":"Aviva Insurance Co."},"prev_policy_type":{"value":"CGL"},"prev_term_start":{"value":1374811200},"prev_term_end":{"value":1375243200}}]},"postal_code":{"updated_at":1374106233232,"value":"AAA111"},"prev_broker":{"updated_at":1374106390158,"value":"Brool Story Co"},"prev_insurer":{"updated_at":1374106390158,"value":"Insurer Co"},"prev_policy_infos":{"updated_at":1374691420637,"value":[]},"prev_policy_number":{"updated_at":1374106390158,"value":"300"},"prev_premium":{"updated_at":1374106390158,"value":"5"},"prev_premium_monthly_or_annual":{"updated_at":1374106390158,"value":"annually"},"prev_term_end":{"updated_at":1374106390158,"value":"2009-04-03"},"prev_term_start":{"updated_at":1374106390158,"value":"2009-03-03"},"province":{"updated_at":1374693038438,"value":"Alberta"},"renewal_explanation":{"updated_at":1374106390158,"value":"we suck dick"},"renewal_offered":{"updated_at":1374106390158,"value":"no"},"required_by":{"updated_at":1374106445802,"value":"2009-01-01"},"updated_at":"2013-07-24T23:41:17Z","website":{"updated_at":1374106233232,"value":"test.com"}}')
data['brokerOfficeShort'] = 'NII'
data['companyShort'] = 'C'
data['brokerage'] = JSON.parse('{"_id":{"$oid":"51e4374f5ea3b7ed6700000c"},"address":"315 King St. N","clients":[{"_id":"14103e979da016ec3e87","blanket_coverages":{"created_at":1378753028,"updated_at":1378845894,"value":[{"id":"141098edfe902828876d","created_at":1378844860,"updated_at":1378844860,"type":{"created_at":1378844860,"updated_at":1378844860,"value":"Accounts Receivable (Broad)"},"category":{"created_at":1378844860,"updated_at":1378844860,"value":"Property"},"deductible":{"created_at":1378844860,"updated_at":1378844860,"value":"1000"},"coinsurance":{"created_at":1378844860,"updated_at":1378844860,"value":""},"limit":{"created_at":1378844860,"updated_at":1378844860,"value":"50000"}}]},"brokerage_id":{"$oid":"51e4374f5ea3b7ed6700000c"},"business_sector":{"created_at":1378750152,"updated_at":1378750152,"value":"Generic"},"claims_infos":{"created_at":1378844910,"updated_at":1378845894,"value":[{"id":"1410995c21e037e54f58","created_at":1378845311,"updated_at":1378845343,"loss_date":{"created_at":1378845311,"updated_at":1378845311,"value":1378180800},"claim_type":{"created_at":1378845331,"updated_at":1378845343,"value":""}}]},"company_name":{"created_at":1378750152,"updated_at":1378750152,"value":"Test Company"},"covered":{"created_at":1378838244,"updated_at":1378838244,"value":""},"created_at":"2013-09-09T18:09:12.892Z","deleted_at":null,"editing_time":321,"form_of_business":{"created_at":1378845156,"updated_at":1378845156,"value":"Individual"},"locations":{"created_at":1378750185,"updated_at":1378845894,"value":[{"id":"14103e9df9203b068efd","created_at":1378750185,"updated_at":1378845894,"location_number":{"created_at":1378750185,"updated_at":1378750185,"value":"1"},"construction_area":{"created_at":1378753331,"updated_at":1378753331,"value":{"qty":"1234","unit":"Sq. m."}},"renovations_plumbing":{"created_at":1378753338,"updated_at":1378753338,"value":{}},"buildings":{"created_at":1378750684,"updated_at":1378845894,"value":[{"id":"141098bcb1b03a438de9","created_at":1378844658,"updated_at":1378844658,"building_number":{"created_at":1378844658,"updated_at":1378844658,"value":"1234"}}]},"coverage_schedules":{"created_at":1378750185,"updated_at":1378845894,"value":[{"id":"141055f19d601807ec7f","created_at":1378774620,"updated_at":1378774620,"type":{"created_at":1378774620,"updated_at":1378774620,"value":"Computers"},"category":{"created_at":1378774620,"updated_at":1378774620,"value":"Property"},"subtype":{"created_at":1378774620,"updated_at":1378774620,"value":"broad"},"deductible":{"created_at":1378774620,"updated_at":1378774620,"value":"1000"},"coinsurance":{"created_at":1378774620,"updated_at":1378774620,"value":"90%"},"limit":{"created_at":1378774620,"updated_at":1378774620,"value":"25000"}}]}},{"id":"141098deebc025ba4a12","created_at":1378844812,"updated_at":1378844812,"location_number":{"created_at":1378844812,"updated_at":1378844812,"value":"2"},"location_type":{"created_at":1378844812,"updated_at":1378844812,"value":"Urban"}}]},"policy_infos":{"created_at":1378844471,"updated_at":1378844765,"value":[]},"prev_policy_infos":{"created_at":1378845892,"updated_at":1378845894,"value":[{"id":"141099e9f93018b3fa04","created_at":1378845892,"updated_at":1378845892,"prev_insurer":{"created_at":1378845892,"updated_at":1378845892,"value":"1234"},"prev_policy_type":{"created_at":1378845892,"updated_at":1378845892,"value":"CGL"}}]},"updated_at":"2013-09-10T20:44:54.000Z","website":{"created_at":1378844905,"updated_at":1378845818,"value":""}},{"_id":"14109a001d602530b7a8","account_number":{"created_at":1378846443,"updated_at":1378846469,"value":"12345"},"brokerage_id":{"$oid":"51e4374f5ea3b7ed6700000c"},"business_sector":{"created_at":1378845993,"updated_at":1378845993,"value":"Generic"},"company_name":{"created_at":1378845993,"updated_at":1378845993,"value":"SciGit"},"created_at":"2013-09-10T20:46:33.435Z","deleted_at":null,"editing_time":91,"form_of_business":{"created_at":1378845993,"updated_at":1378845993,"value":"Corporation"},"updated_at":"2013-09-10T20:57:48.000Z","website":{"created_at":1378846029,"updated_at":1378846668,"value":"12345"}}],"contacts":[{"name":"asdf","title":"asdf"}],"created_at":"2013-07-15T17:54:23.641Z","deleted_at":null,"employees":22,"fax":"","name":"SciGit Inc.","num_clients":null,"phone":"5194048124","updated_at":"2013-08-15T23:26:45.765Z","website":"www.scigit.com"}')

fields = YAML::load(File.open('client.yml'))
argv = ARGV.dup
if !argv[0].nil?
  if defined? RubyProf
    RubyProf.start
  end

  YDocx::Document.fill_template(argv[0], data, fields, argv[1] || (File.basename(argv[0], '.docx') + '.out.docx'), options)
  if defined? RubyProf
    result = RubyProf.stop
    printer = RubyProf::GraphHtmlPrinter.new(result)
    printer.print(STDOUT)
  end
  puts 'Successfully filled template with data.'
else
  puts 'usage: templatex [options] template_file output_file'
end
